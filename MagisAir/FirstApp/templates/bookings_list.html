{% extends 'base.html' %}

{% block title %}My Bookings{% endblock %}

{% block content %}
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button class="btn btn-primary" type="submit">Create New Booking</button>
    </form>

    <div class="row">
    <div class="col">
    <h1>Unpaid Bookings</h1>
        {% for booking in unpaid_bookings %}
        <div class="booking rounded-4 p-3" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        <!-- Fixed per-user booking number -->
        <h2>Booking #{{ booking.booking_id }}</h2>

        <!-- Flights list, hidden by default -->
        <ul class="flights-list" style="display: none; list-style-type: none; padding-left: 0;">
          {% for itinerary in booking.itinerary_set.all %}
            <li style="border-top: 1px solid #eee; padding: 5px 0;">
            <div class="p-4 row">
              <div class="col-md-8">
                    <h4 class="fw-semibold mb-1"> Flight No. {{itinerary.flight.flight_num}}</h4>

                    <h5 class="fw-semibold mb-1">
                        {{ itinerary.flight.route.origin.city_name }} → {{ itinerary.flight.route.destination.city_name }}
                    </h5>

                    <p class="text-muted mb-1">
                        <strong>Departure:</strong> {{ itinerary.flight.departure }}
                    </p>

                    <p class="text-muted mb-3">
                        <strong>Arrival:</strong> {{ itinerary.flight.arrival }}
                    </p>
                </div>
                <div class="col-4 fw-semibold fs-5 text-primary mb-0">
                        ₱ {{ itinerary.flight.flight_cost|floatformat:2 }}
                </div>
            </div>
            </li>
          {% endfor %}
        </ul>
        <div class="fw-semibold fs-5 text-primary mb-1 p-3 align-self-end">Total Cost: ₱ {{ booking.total_cost|floatformat:2 }}</div>
        

        <!-- Toggle button -->
        {% if booking.itinerary_set.all %}
        <div class="d-flex justify-content-end gap-3">
        <button class="btn btn-outline-primary toggle-flights">Show Flights</button>

        <a class="btn btn-primary" href="{% url 'bookings:bookings_update' booking.booking_id %}">Pay for this booking</a>
        </div>
        {% else %}
        No flights in this booking.
        {% endif %}
        </div>

        {% empty %}
            <p>All bookings have been paid for.</p>
        {% endfor %}
    </div>

    <div class="col">
    <h1>Paid Bookings</h1>
        {% for booking in paid_bookings %}
        <div class="booking rounded-4 p-3" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        <!-- Fixed per-user booking number -->
        <h2>Booking #{{ booking.booking_id }}</h2>

        <!-- Flights list, hidden by default -->
        <ul class="flights-list" style="display: none; list-style-type: none; padding-left: 0;">
          {% for itinerary in booking.itinerary_set.all %}
            <li style="border-top: 1px solid #eee; padding: 5px 0;">
            <div class="p-4 row">
              <div class="col-md-8">
                    <h4 class="fw-semibold mb-1"> Flight No. {{itinerary.flight.flight_num}}</h4>

                    <h5 class="fw-semibold mb-1">
                        {{ itinerary.flight.route.origin.city_name }} → {{ itinerary.flight.route.destination.city_name }}
                    </h5>

                    <p class="text-muted mb-1">
                        <strong>Departure:</strong> {{ itinerary.flight.departure }}
                    </p>

                    <p class="text-muted mb-3">
                        <strong>Arrival:</strong> {{ itinerary.flight.arrival }}
                    </p>
                </div>
                <div class="col-4 fw-semibold fs-5 text-primary mb-0">
                        ₱ {{ itinerary.flight.flight_cost|floatformat:2 }}
                </div>
            </div>
            </li>
          {% endfor %}
        </ul>
        <div class="fw-semibold fs-5 text-primary mb-1 p-3 align-self-end">Total Cost: ₱ {{ booking.total_cost|floatformat:2 }}</div>

        <!-- Toggle button -->
        {% if booking.itinerary_set.all %}
        <div class="d-flex justify-content-end gap-3">
        <button class="btn btn-outline-primary toggle-flights">Show Flights</button>
        </div>
        {% else %}
        No flights in this booking.
        {% endif %}
        </div>

        {% empty %}
        <p>You have no paid bookings.</p>
        {% endfor %}
    </div>
    </div>
    </div>

    <!-- JS to toggle flights visibility -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const buttons = document.querySelectorAll('.toggle-flights');
      buttons.forEach(button => {
        button.addEventListener('click', function() {
          const flightsList = this.parentElement.previousElementSibling.previousElementSibling;
          if (flightsList.style.display === 'none') {
            flightsList.style.display = 'block';
            this.textContent = 'Hide Flights';
          } else {
            flightsList.style.display = 'none';
            this.textContent = 'Show Flights';
          }
        });
      });
    });
    </script>
{% endblock %}